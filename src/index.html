<!DOCTYPE html>
<html>
    <head>
        <title></title>

        <script src='/socket.io/socket.io.js'></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/7.3.0/adapter.min.js" integrity="sha256-2qQheewaqnZlXJ3RJRghVUwD/3fD9HNqxh4C+zvgmF4=" crossorigin="anonymous"></script>
    </head>

    <body>
        <h2>Video Call</h2>
        <div id='videos'>
            <video id='local' height="300" autoplay muted></video>
            <video id='remote' height="300" style="margin: 10px;" autoplay></video>
        </div>


        <script>
            window.addEventListener('load', ()=>{
                const room = getQString(location.href, 'room');
                const streamConstraints = {video:true, audio:true};
                var pc = [];

                let socket = io('/stream');

                const username = Math.random().toString(36).slice(2).substring(0, 15);

                socket.emit('subscribe', {
                    room: room,
                    username: username
                });


                socket.on('new user', (data)=>{console.log(data)
                    socket.emit('newUserStart', {to:data.username, sender:username});
                    pc.push(data.username);
                    init(true, data.username);
                });


                socket.on('newUserStart', (data)=>{console.log(data)
                    pc.push(data.sender);
                    init(false, data.sender);
                });


                socket.on('ice candidates', async (data)=>{console.log(data)
                    data.candidate ? await pc[data.sender].addIceCandidate(new RTCIceCandidate(data.candidate)) : '';
                });


                socket.on('sdp', async (data)=>{console.log(data)
                    if(data.description.type === 'offer'){console.log('sdp is offer')
                        await pc[data.sender].setRemoteDescription(new RTCSessionDescription(data.description));

                        navigator.mediaDevices.getUserMedia(streamConstraints).then(async (stream)=>{
                            if(!document.getElementById('local').srcObject){
                                document.getElementById('local').srcObject = stream;
                            }

                            stream.getTracks().forEach((track)=>{
                                pc[data.sender].addTrack(track, stream);
                            });

                            let answer = await pc[data.sender].createAnswer();
                            
                            await pc[data.sender].setLocalDescription(answer);

                            socket.emit('sdp', {description:pc[data.sender].localDescription, to:data.sender, sender:username});
                        }).catch((e)=>{
                            console.error(e);
                        });
                    }

                    else if(data.description.type === 'answer'){console.log('sdp is answer')
                        await pc[data.sender].setRemoteDescription(new RTCSessionDescription(data.description));
                    }
                });


                function getQString(url='', keyToReturn=''){
                    url = url ? url : location.href;
                    let queryStrings = decodeURIComponent(url).split('#', 2)[0].split('?', 2)[1];
                    
                    if(queryStrings){
                        let splittedQStrings = queryStrings.split('&');
                        
                        if(splittedQStrings.length){
                            let queryStringObj = {};
                            
                            splittedQStrings.forEach(function(keyValuePair){
                                let keyValue = keyValuePair.split('=', 2);
                                
                                if(keyValue.length){
                                    queryStringObj[keyValue[0]] = keyValue[1];
                                }
                            });            
                            
                            return keyToReturn ? (queryStringObj[keyToReturn] ? queryStringObj[keyToReturn] : null) : queryStringObj;
                        }
                        
                        return null;
                    }
                    
                    return null;
                }

                function init(createOffer, partnerName){console.log(partnerName);
                    pc[partnerName] = new RTCPeerConnection({iceServers: [{   urls: [ "stun:eu-turn4.xirsys.com" ]}, {   username: "ml0jh0qMKZKd9P_9C0UIBY2G0nSQMCFBUXGlk6IXDJf8G2uiCymg9WwbEJTMwVeiAAAAAF2__hNSaW5vbGVl",   credential: "4dd454a6-feee-11e9-b185-6adcafebbb45",   urls: [       "turn:eu-turn4.xirsys.com:80?transport=udp",       "turn:eu-turn4.xirsys.com:3478?transport=udp",       "turn:eu-turn4.xirsys.com:80?transport=tcp",       "turn:eu-turn4.xirsys.com:3478?transport=tcp",       "turns:eu-turn4.xirsys.com:443?transport=tcp",       "turns:eu-turn4.xirsys.com:5349?transport=tcp"   ]}]});
                    
                    navigator.mediaDevices.getUserMedia(streamConstraints).then((stream)=>{
                        stream.getTracks().forEach((track)=>{
                            pc[partnerName].addTrack(track, stream);//should trigger negotiationneeded event
                        });

                        document.getElementById('local').srcObject = stream;
                    }).catch((e)=>{
                        console.log(`stream error: ${e}`);
                    });



                    //create offer
                    // pc[partnerName].onnegotiationneeded = async ()=>{
                    //     let offer = await pc[partnerName].createOffer();
                        
                    //     await pc[partnerName].setLocalDescription(offer);

                    //     socket.emit('sdp', {description:pc[partnerName].localDescription, to:partnerName, sender:username});
                    // };
                    if(createOffer){console.log('create offer is true')
                        pc[partnerName].createOffer().then((offer)=>{console.log('Offer created')
                            pc[partnerName].setLocalDescription(offer).then(()=>{console.log('local desc set')
                                socket.emit('sdp', {description:pc[partnerName].localDescription, to:partnerName, sender:username});
                            }).catch((e)=>{
                                console.error('Error setting local description for partner: '+e);
                            });
                        }).catch((err)=>{
                            console.error('Error creating offer: '+err);
                        });
                    }

                    // else{
                    //     pc[partnerName].createAnswer().then((answer)=>{
                    //         pc[partnerName].setLocalDescription(answer).then(()=>{
                    //             socket.emit('sdp', {description:pc[partnerName].localDescription, to:partnerName, sender:username});
                    //         }).catch();
                    //     }).catch();
                    // }



                    //send ice candidate to partnerNames
                    pc[partnerName].onicecandidate = ({candidate})=>{console.log('ice available')
                        socket.emit('ice candidates', {candidate: candidate, to:partnerName, sender:username});
                    };



                    //add
                    pc[partnerName].ontrack = (e)=>{console.log('track available')
                        let str = e.streams[0];
                        console.info('we have track', str);
                        document.getElementById('remote').srcObject = e.streams[0];

                        if(document.getElementById(partnerName).length){console.log('partner exists')
                            document.getElementById(partnerName).srcObject = str;
                        }

                        else{console.log('new partner')
                            let newVid = document.createElement('video');
                            newVid.id = partnerName;
                            newVid.srcObject = str;
                            newVid.autoplay = true;
                            newVid.height = 300;

                            document.getElementById('videos').appendChild(newVid);
                        }
                    };



                    pc[partnerName].onconnectionstatechange = ()=>{};



                    pc[partnerName].onsignalingstatechange = ()=>{};
                }

                
                // document.getElementById('pipBtn').addEventListener('click', ()=>{
                //     if(document.pictureInPictureElement){
                //         document.exitPictureInPicture();
                //     }
                    
                //     else{
                //         document.getElementById('vid').requestPictureInPicture();
                //     }
                // })
            });
        </script>
    </body>
</html>